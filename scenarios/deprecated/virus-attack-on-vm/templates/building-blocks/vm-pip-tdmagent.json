{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "_artifactsLocation": {
            "type": "string"
        },
        "_artifactsLocationSasToken": {
            "type": "securestring"
        },
        "vnetName": {
            "type": "string"
        },
        "vmName": {
            "type": "string"
        },
        "osSku": {
            "type": "string"
        },
        "location": {
            "type": "string"
        },
        "username": {
            "type": "string"
        },
        "password": {
            "type": "securestring"
        },
        "managerAddress": {
            "type": "string"
        },
        "heartbeatPortTrendDSM": {
            "type": "string"
        },
        "tenantIdentifier": {
            "type": "string"
        },
        "tenantActivationPassword": {
            "type": "string"
        },
        "count": {
            "type": "int"
        },
        "securityGroupNameTrendDSA": {
            "type": "string"
        },
        "managerPortTrendDSM": {
            "type": "string"
        }
    },
    "variables": {},
    "resources": [
        {
            "apiVersion": "2017-06-01",
            "type": "Microsoft.Network/networkSecurityGroups",
            "name": "[parameters('securityGroupNameTrendDSA')]",
            "location": "[parameters('location')]",
            "properties": {
                "securityRules": [
                    {
                        "name": "allow-inbound-ssh",
                        "properties": {
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "22",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 1000,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "allow-inbound-dsmportal",
                        "properties": {
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "[parameters('managerPortTrendDSM')]",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 1100,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "allow-inbound-dsmagent",
                        "properties": {
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "4118",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 1200,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "allow-inbound-dsmheartbeat",
                        "properties": {
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "[parameters('heartbeatPortTrendDSM')]",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 1300,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "allow-inbound-dsmdownload",
                        "properties": {
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "4122",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 1400,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "allow-inbound-dsmwebinstaller",
                        "properties": {
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "8443",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 1500,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "allow-inbound-rdp",
                        "properties": {
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "3389",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 1600,
                            "direction": "Inbound"
                        }
                    }                    
                ]
            }
        },
        {
            "apiVersion": "2017-05-10",
            "name": "[concat(parameters('vmName'),'-',copyIndex(),'-pip')]",
            "type": "Microsoft.Resources/deployments",
            "copy": {
                "name": "copy-pip",
                "count": "[parameters('count')]"
            },
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('_artifactsLocation'),'/resources/microsoft.network/publicipaddress.json',parameters('_artifactsLocationSasToken'))]"
                },
                "parameters": {
                    "publicIPAddressName": {
                        "value": "[concat(parameters('vmName'),'-',copyIndex(),'-pip')]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    }
                }
            }
        },
        {
            "apiVersion": "2017-05-10",
            "name": "[concat(parameters('vmName'),'-',copyIndex(),'-nic')]",
            "type": "Microsoft.Resources/deployments",
            "dependsOn": [
                "copy-pip",
                "[parameters('securityGroupNameTrendDSA')]"
            ],
            "copy": {
                "name": "copy-nic",
                "count": "[parameters('count')]"
            },
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('_artifactsLocation'),'/resources/microsoft.network/nic-with-pip.json',parameters('_artifactsLocationSasToken'))]"
                },
                "parameters": {
                    "nicName": {
                        "value": "[concat(parameters('vmName'),'-',copyIndex(),'-nic')]"
                    },
                    "publicIPAddressId": {
                        "value": "[resourceId('Microsoft.Network/publicIPAddresses',concat(parameters('vmName'),'-',copyIndex(),'-pip'))]"
                    },
                    "subnetId": {
                        "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets',parameters('vnetName'),'default')]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "nsgId": {
                        "value": "[resourceId('Microsoft.Network/networkSecurityGroups',parameters('securityGroupNameTrendDSA'))]"
                    }
                }
            }
        },
        {
            "apiVersion": "2017-05-10",
            "name": "[concat(parameters('vmName'),'-',copyIndex())]",
            "type": "Microsoft.Resources/deployments",
            "dependsOn": [
                "copy-nic"
            ],
            "copy": {
                "name": "copy-vm",
                "count": "[parameters('count')]"
            },
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('_artifactsLocation'),'/resources/microsoft.compute/vmfromimage.json',parameters('_artifactsLocationSasToken'))]"
                },
                "parameters": {
                    "vmName": {
                        "value": "[concat(parameters('vmName'),'-',copyIndex())]"
                    },
                    "adminUsername": {
                        "value": "[parameters('username')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('password')]"
                    },
                    "nicId": {
                        "value": "[resourceId('Microsoft.Network/networkInterfaces',concat(parameters('vmName'),'-',copyIndex(),'-nic'))]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "osSku": {
                        "value": "[parameters('osSku')]"
                    }
                }
            }
        },
        {
            "apiVersion": "2015-01-01",
            "type": "Microsoft.Resources/deployments",
            "name": "[concat('dsagent-',copyIndex())]",
            "dependsOn": [
                "copy-vm"
            ],
            "copy": {
                "name": "copy-dsa-extension",
                "count": "[parameters('count')]"
            },
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('_artifactsLocation'),'/resources/microsoft.compute/extension.dsa.json',parameters('_artifactsLocationSasToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "vmName": {
                        "value": "[concat(parameters('vmName'),'-',copyIndex())]"
                    },
                    "managerAddress": {
                        "value": "[parameters('managerAddress')]"
                    },
                    "activationPort": {
                        "value": "[parameters('heartbeatPortTrendDSM')]"
                    },
                    "tenantIdentifier": {
                        "value": "[parameters('tenantIdentifier')]"
                    },
                    "tenantActivationPassword": {
                        "value": "[parameters('tenantActivationPassword')]"
                    }
                }
            }
        }
    ],
    "outputs": {}
}